.. _csharp-guids:

==================
GUID Serialization
==================

.. default-domain:: mongodb

.. contents:: On this page
   :local:
   :backlinks: none
   :depth: 2
   :class: singlecol

Overview
--------

In this guide, you can learn how to serialize 
`**globally unique identifiers** <https://learn.microsoft.com/en-us/dynamicsax-2012/developer/guids>`__ 
(GUIDs), also known as **universally unique identifiers** (UUIDs).

A GUID is a 16-byte integer that you can use as a unique ID. MongoDB GUIDs were originally
represented as ``BsonBinaryData`` values of subtype 3. 
Because different drivers used different byte orders when representing GUIDs, we created
subtype 4 to standardize the byte order across drivers. 

.. tip::
   
   Because subtype 4 of ``BsonBinaryData`` standardizes byte order, we recommend 
   representing all GUIDs with this format. 

GuidRepresentationMode
----------------------

Older collections may contain documents in which some GUID fields
use ``BsonBinaryData`` subtype 3 and others use subtype 4. You can use the 
``BsonDefaults.GuidRepresentationMode`` property to ensure that the driver 
serializes and deserializes these GUIDs correctly.  

The ``GuidRepresentationMode`` property has two possible values: ``V2`` and ``V3``.

.. note::

   You can't use both ``GuidRepresentationMode.V2`` and ``GuidRepresentationMode.V3`` 
   in a single application.

V2
~~

``GuidRepresentationMode.V2`` assumes that all GUIDs in a collection use the same 
``BsonBinaryData`` subtype (either 3 or 4). In this mode, GUID representation is 
controlled by the reader or writer, not the serializer.

``V2`` is the default ``GuidRepresentationMode``.

V3
~~

``GuidRepresentationMode.V3`` allows documents in the same collection to use different 
GUID formats. 
In this mode, GUID representation is controlled at the property level by configuring the 
serializer for each property.

To use ``GuidRepresentationMode.V3``, run the following line of code as early in your 
application as possible:

.. code-block:: csharp

   BsonDefaults.GuidRepresentationMode = GuidRepresentationMode.V3;

Running in ``V3`` mode changes the behavior of the driver in the following ways:

- The ``BsonBinaryReader.ReadBinaryData()`` method ignores ``readerSettings.GuidRepresentation``
- The ``BsonBinaryWriter.WriteBinaryData()`` method ignores ``writerSettings.GuidRepresentation``
- The ``JsonReader.ReadBinaryData()`` method ignores ``readerSettings.GuidRepresentation``
- ``JsonWriter`` ignores ``writerSettings.GuidRepresentation``
- If you call the ``BsonBinaryData.ToGuid()`` method without the ``GuidRepresentation``
  parameter, it will work only on GUIDs of subtype 4.

.. note::
   
   When version 3 of the {+driver-short+} is released, support for ``GuidRepresentationMode.V2``
   will be removed from the driver and ``V3`` will become the default. 

Serializing GUIDs in V3
-----------------------

``GuidRepresentationMode.V3`` handles GUID serialization at the level of individual
properties. This is more flexible than ``V2``, but it also means you must ensure that 
each GUID is serialized and deserialized correctly.

If you're using the driver to :ref:`automap your {+language+} classes to document schemas <csharp-automapping>`,
you can use the ``BsonGuidRepresentation`` attribute on a GUID property 
to specify the representation:

.. code-block:: csharp

   public class Widget
   {
       public int Id { get; set; }

      [BsonGuidRepresentation(GuidRepresentation.Standard)]
      public Guid G { get; set; }
}

If you're writing your own serialization and deserialization code, you can use the 
``GuidSerializer`` class to ensure that the driver handles GUIDs correctly.
When you construct a ``GuidSerializer``, use the ``GuidRepresentation`` parameter
to specify the GUID representation. 

The following code sample creates an instance of ``GuidSerializer`` 
for serializing GUID representations of subtype 4 (``Standard``):

.. code-block::

   var guidSerializer = new GuidSerializer(GuidRepresentation.Standard);

If most of your GUIDs use the same representation, you can register a global 
``GuidSerializer`` for this representation, then use the ``BsonGuidRepresentation``
attribute for the other GUIDs. To create and register a ``GuidSerializer``, run the 
following code early in your application:

.. code-block:: csharp

   BsonSerializer.RegisterSerializer(new GuidSerializer(GuidRepresentation.Standard));

Serializing Objects in V3
-------------------------

To ensure that GUIDs in objects are serialized and deserialized correctly when using 
``V3``, you should select the correct GUID representation when constructing your 
``ObjectSerializer``. The following code sample shows how to 
create an ``ObjectSerializer`` for a GUID representation of subtype 4:

.. code-block:: csharp

   var objectDiscriminatorConvention = BsonSerializer.LookupDiscriminatorConvention(typeof(object));
   var objectSerializer = new ObjectSerializer(objectDiscriminatorConvention, GuidRepresentation.Standard);

If your application relies on an ``ObjectSerializer`` to serialize any GUIDs, you 
must also register the serializer early in your application. The serializer that you 
register will be used globally whenever an object serializer is needed and has not 
been otherwise specified.

To register your ``ObjectSerializer``, pass it to the ``BsonSerializer.RegisterSerializer()``
method:

.. code-block:: csharp
   :emphasize-lines: 3

   var objectDiscriminatorConvention = BsonSerializer.LookupDiscriminatorConvention(typeof(object));
   var objectSerializer = new ObjectSerializer(objectDiscriminatorConvention, GuidRepresentation.Standard);
   BsonSerializer.RegisterSerializer(objectSerializer);

Additional Information
----------------------

To learn more about any of the methods or types discussed in this
guide, see the following API documentation:

- `BsonBinaryData <{+api-root+}/T_MongoDB_Bson_BsonBinaryData.htm>`__
- `GuidRepresentationMode {+api-root+}/T_MongoDB_Bson_GuidRepresentationMode.htm>`__
- `BsonGuidRepresentation {+api-root+}/T_MongoDB_Bson_Serialization_Attributes_BsonGuidRepresentationAttribute.htm>`__
- `GuidSerializer {+api-root+}/T_MongoDB_Bson_Serialization_Serializers_GuidSerializer.htm>`__
- `ObjectSerializer {+api-root+}/T_MongoDB_Bson_Serialization_Serializers_ObjectSerializer.htm>`__

